<!DOCTYPE html>
<html lang="es">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-EVTW1307T1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date());
    gtag('config', 'G-EVTW1307T1');
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Symfony ORM Doctrine</title>
  <script src="/course-resources/index.js" defer></script>
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/default.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
  <script src="https://kit.fontawesome.com/a7cd9537ed.js" crossorigin="anonymous"></script>
  <script src="../index.js" defer></script>
  <script src="../menu.js" defer></script>
  <!-- <link rel="stylesheet" href="../index.css"> -->
  <link rel="stylesheet" href="../style.css" />
  <link rel="stylesheet" href="../menu.css">
</head>


<body>


  <nav id="vc-rail" class="vc-rail" aria-hidden="true">
    <div class="vc-rail-head">
      <span class="vc-rail-title">Índice</span>
      <button id="vc-close" class="vc-btn" aria-label="Cerrar menú">
        <!-- X SVG -->
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>
      </button>
    </div>
    <ul id="vc-list" class="vc-list"></ul>
  </nav>

  <div id="vc-backdrop" class="vc-backdrop" hidden></div>
  <!-- ===== /VC SIDEBAR ===== -->

  <header>

    <!-- ===== VC SIDEBAR (desde cero) ===== -->
    <button style="margin-top: 0!important;" id="vc-toggle" class="vc-toggle" aria-label="Mostrar/ocultar menú" aria-controls="vc-rail"
      aria-expanded="false">
      <!--Hamburger icon -->
      <i class="fa fa-bars" aria-hidden="true"></i>


    </button>
    <h1>Symfony ORM Doctrine</h1>
    <img src="" id="logo" alt="Logo" style="display: none;">
  </header>

<main>

<!-- SECCIÓN 1 -->
<section id="introduccion">
<h2>1. Introducción a Doctrine ORM</h2>

<p>
En esta sección comprenderás qué es Doctrine y por qué es el ORM estándar en Symfony.
</p>

<p>
<strong>Doctrine</strong> es el ORM que usa Symfony. Permite trabajar con la base de datos
mediante <strong>entidades PHP</strong>, evitando escribir SQL directamente.
Cada entidad representa una tabla.
</p>
</section>

<!-- SECCIÓN 2 -->
<section id="entity">
<h2>2. Entidades Doctrine</h2>

<p>
Aquí aprenderás a crear entidades y a trabajar con repositorios para gestionar datos.
</p>

<h3>2.1. Crear una entidad</h3>

<pre><code class="language-bash">
php bin/console make:entity Hotel
</code></pre>

<h3>2.2. Entidad básica</h3>

<pre><code class="language-php">
&lt;?php
namespace App\Entity;

use Doctrine\ORM\Mapping as ORM;

#[ORM\Entity]
class Hotel
{
  #[ORM\Id]
  #[ORM\GeneratedValue]
  #[ORM\Column]
  private ?int $id = null;

  #[ORM\Column(length: 255)]
  private string $nombre;

  #[ORM\Column(length: 255, nullable: true)]
  private ?string $direccion = null;
}
</code></pre>

<h3>2.3. Uso básico del repositorio</h3>

<pre><code class="language-php">
use App\Entity\Hotel;
use App\Repository\HotelRepository;
use Doctrine\ORM\EntityManagerInterface;

// Insertar
$hotel = new Hotel();
$hotel->setNombre('Gran Hotel');
$hotel->setDireccion('Calle Mayor 3');
$em->persist($hotel);
$em->flush();

// Consultar
$hoteles = $hotelRepository->findAll();

// Buscar por ID
$hotel = $hotelRepository->find(1);

// Eliminar
$em->remove($hotel);
$em->flush();
</code></pre>
</section>

<!-- SECCIÓN 3 -->
<section id="doctrine-crud">
<h2>3. CRUD con Doctrine</h2>

<p>
Verás cómo realizar operaciones de creación, lectura, actualización y borrado con Doctrine.
</p>

<h3>3.1. CREATE</h3>
<pre><code class="language-php">
$hotel = new Hotel();
$hotel->setNombre('Hotel Central');
$hotel->setDireccion('Avenida Principal 10');
$em->persist($hotel);
$em->flush();
</code></pre>

<h3>3.2. READ</h3>
<pre><code class="language-php">
$hoteles = $hotelRepository->findBy([
  'nombre' => 'Hotel Central'
]);

// Con QueryBuilder
$hoteles = $hotelRepository->createQueryBuilder('h')
  ->where('h.nombre LIKE :nombre')
  ->setParameter('nombre', '%Hotel%')
  ->getQuery()
  ->getResult();
</code></pre>

<h3>3.3. UPDATE</h3>
<pre><code class="language-php">
$hotel = $hotelRepository->find(1);
$hotel->setDireccion('Nueva dirección');
$em->flush();
</code></pre>

<h3>3.4. DELETE</h3>
<pre><code class="language-php">
$hotel = $hotelRepository->find(1);
$em->remove($hotel);
$em->flush();
</code></pre>
</section>

<!-- SECCIÓN 4 -->
<section id="relaciones">
<h2>4. Relaciones Doctrine</h2>

<p>
Aprenderás a definir relaciones entre entidades para modelar datos conectados.
</p>

<h3>4.1. Relación 1:1 (Uno a Uno)</h3>

<p>
Una relación 1:1 significa que un registro en una tabla está asociado con exactamente un registro en otra tabla.
Ejemplo: Un hotel tiene un único gerente.
</p>

<h4>Definición en entidades</h4>

<pre><code class="language-php">
// src/Entity/Hotel.php
#[ORM\OneToOne(mappedBy: 'hotel', cascade: ['persist', 'remove'])]
private ?Gerente $gerente = null;

public function getGerente(): ?Gerente
{
    return $this->gerente;
}

public function setGerente(?Gerente $gerente): static
{
    if ($gerente === null && $this->gerente !== null) {
        $this->gerente->setHotel(null);
    }
    
    if ($gerente !== null && $gerente->getHotel() !== $this) {
        $gerente->setHotel($this);
    }
    
    $this->gerente = $gerente;
    return $this;
}
</code></pre>

<pre><code class="language-php">
// src/Entity/Gerente.php
#[ORM\OneToOne(inversedBy: 'gerente', cascade: ['persist', 'remove'])]
#[ORM\JoinColumn(nullable: false)]
private ?Hotel $hotel = null;

public function getHotel(): ?Hotel
{
    return $this->hotel;
}

public function setHotel(?Hotel $hotel): static
{
    $this->hotel = $hotel;
    return $this;
}
</code></pre>

<h4>Uso de la relación 1:1</h4>

<pre><code class="language-php">
// Obtener el gerente de un hotel
$hotel = $hotelRepository->find(1);
echo $hotel->getGerente()->getNombre();

// Obtener el hotel de un gerente
$gerente = $gerenteRepository->find(1);
echo $gerente->getHotel()->getNombre();

// Crear un gerente para un hotel
$hotel = $hotelRepository->find(1);
$gerente = new Gerente();
$gerente->setNombre('Juan Pérez');
$gerente->setEmail('juan@hotel.com');
$hotel->setGerente($gerente);
$em->flush();
</code></pre>

<h3>4.2. Relación 1:N (Uno a Muchos)</h3>

<p>
Una relación 1:N significa que un registro puede tener múltiples registros relacionados.
Ejemplo: Un hotel tiene muchas habitaciones.
</p>

<h4>Definición en entidades</h4>

<pre><code class="language-php">
// src/Entity/Hotel.php
use Doctrine\Common\Collections\ArrayCollection;
use Doctrine\Common\Collections\Collection;

#[ORM\OneToMany(mappedBy: 'hotel', targetEntity: Habitacion::class, orphanRemoval: true)]
private Collection $habitaciones;

public function __construct()
{
    $this->habitaciones = new ArrayCollection();
}

public function getHabitaciones(): Collection
{
    return $this->habitaciones;
}

public function addHabitacion(Habitacion $habitacion): static
{
    if (!$this->habitaciones->contains($habitacion)) {
        $this->habitaciones->add($habitacion);
        $habitacion->setHotel($this);
    }
    return $this;
}

public function removeHabitacion(Habitacion $habitacion): static
{
    if ($this->habitaciones->removeElement($habitacion)) {
        if ($habitacion->getHotel() === $this) {
            $habitacion->setHotel(null);
        }
    }
    return $this;
}
</code></pre>

<pre><code class="language-php">
// src/Entity/Habitacion.php
#[ORM\ManyToOne(inversedBy: 'habitaciones')]
#[ORM\JoinColumn(nullable: false)]
private ?Hotel $hotel = null;

public function getHotel(): ?Hotel
{
    return $this->hotel;
}

public function setHotel(?Hotel $hotel): static
{
    $this->hotel = $hotel;
    return $this;
}
</code></pre>

<h4>Uso de la relación 1:N</h4>

<pre><code class="language-php">
// Obtener todas las habitaciones de un hotel
$hotel = $hotelRepository->find(1);
foreach ($hotel->getHabitaciones() as $habitacion) {
    echo $habitacion->getNumero();
}

// Obtener el hotel de una habitación
$habitacion = $habitacionRepository->find(1);
echo $habitacion->getHotel()->getNombre();

// Crear habitaciones para un hotel
$hotel = $hotelRepository->find(1);
$habitacion = new Habitacion();
$habitacion->setNumero('101');
$habitacion->setTipo('Doble');
$hotel->addHabitacion($habitacion);
$em->flush();

// Contar habitaciones de un hotel
$cantidad = $hotel->getHabitaciones()->count();

// Eliminar una habitación de un hotel
$hotel->removeHabitacion($habitacion);
$em->flush();
</code></pre>

<h3>4.3. Relación N:M (Muchos a Muchos)</h3>

<p>
Una relación N:M significa que múltiples registros pueden estar relacionados con múltiples registros.
Ejemplo: Un hotel puede tener muchos servicios, y un servicio puede estar en muchos hoteles.
Doctrine crea automáticamente una <strong>tabla intermedia</strong>.
</p>

<h4>Definición en entidades</h4>

<pre><code class="language-php">
// src/Entity/Hotel.php
#[ORM\ManyToMany(targetEntity: Servicio::class, inversedBy: 'hoteles')]
#[ORM\JoinTable(name: 'hotel_servicio')]
private Collection $servicios;

public function __construct()
{
    $this->servicios = new ArrayCollection();
}

public function getServicios(): Collection
{
    return $this->servicios;
}

public function addServicio(Servicio $servicio): static
{
    if (!$this->servicios->contains($servicio)) {
        $this->servicios->add($servicio);
    }
    return $this;
}

public function removeServicio(Servicio $servicio): static
{
    $this->servicios->removeElement($servicio);
    return $this;
}
</code></pre>

<pre><code class="language-php">
// src/Entity/Servicio.php
#[ORM\ManyToMany(targetEntity: Hotel::class, mappedBy: 'servicios')]
private Collection $hoteles;

public function __construct()
{
    $this->hoteles = new ArrayCollection();
}

public function getHoteles(): Collection
{
    return $this->hoteles;
}

public function addHotel(Hotel $hotel): static
{
    if (!$this->hoteles->contains($hotel)) {
        $this->hoteles->add($hotel);
        $hotel->addServicio($this);
    }
    return $this;
}

public function removeHotel(Hotel $hotel): static
{
    if ($this->hoteles->removeElement($hotel)) {
        $hotel->removeServicio($this);
    }
    return $this;
}
</code></pre>

<h4>Uso de la relación N:M</h4>

<pre><code class="language-php">
// Obtener servicios de un hotel
$hotel = $hotelRepository->find(1);
foreach ($hotel->getServicios() as $servicio) {
    echo $servicio->getNombre();
}

// Obtener hoteles que tienen un servicio
$servicio = $servicioRepository->find(1);
foreach ($servicio->getHoteles() as $hotel) {
    echo $hotel->getNombre();
}

// Asociar servicios a un hotel
$hotel = $hotelRepository->find(1);
$servicio = $servicioRepository->find(1);
$hotel->addServicio($servicio);
$em->flush();

// Desasociar servicios
$hotel->removeServicio($servicio);
$em->flush();

// Verificar si tiene un servicio
if ($hotel->getServicios()->contains($servicio)) {
    echo "El hotel tiene este servicio";
}

// Contar servicios de un hotel
$cantidadServicios = $hotel->getServicios()->count();
</code></pre>

<h4>Relación N:M con atributos extra</h4>

<p>
Para agregar campos adicionales en la tabla intermedia (como precio_adicional), debes crear una entidad intermedia explícita:
</p>

<pre><code class="language-php">
// src/Entity/HotelServicio.php
#[ORM\Entity]
#[ORM\Table(name: 'hotel_servicio')]
class HotelServicio
{
    #[ORM\Id]
    #[ORM\ManyToOne(targetEntity: Hotel::class, inversedBy: 'hotelServicios')]
    #[ORM\JoinColumn(nullable: false)]
    private ?Hotel $hotel = null;

    #[ORM\Id]
    #[ORM\ManyToOne(targetEntity: Servicio::class, inversedBy: 'hotelServicios')]
    #[ORM\JoinColumn(nullable: false)]
    private ?Servicio $servicio = null;

    #[ORM\Column(type: 'decimal', precision: 8, scale: 2, nullable: true)]
    private ?float $precioAdicional = null;

    // Getters y setters...
}
</code></pre>

<pre><code class="language-php">
// Uso con entidad intermedia
$hotelServicio = new HotelServicio();
$hotelServicio->setHotel($hotel);
$hotelServicio->setServicio($servicio);
$hotelServicio->setPrecioAdicional(15.00);
$em->persist($hotelServicio);
$em->flush();
</code></pre>

<h4>Consultas avanzadas con relaciones N:M</h4>

<pre><code class="language-php">
// Filtrar hoteles por servicios
$hoteles = $hotelRepository->createQueryBuilder('h')
    ->innerJoin('h.servicios', 's')
    ->where('s.nombre = :nombre')
    ->setParameter('nombre', 'WiFi')
    ->getQuery()
    ->getResult();

// Contar hoteles con un servicio específico
$cantidad = $hotelRepository->createQueryBuilder('h')
    ->select('COUNT(h.id)')
    ->innerJoin('h.servicios', 's')
    ->where('s.id = :servicioId')
    ->setParameter('servicioId', 1)
    ->getQuery()
    ->getSingleScalarResult();
</code></pre>
</section>

<!-- SECCIÓN 5 -->
<section id="factory">
<h2>5. Fixtures con Faker</h2>

<p>
Esta parte te permite generar datos de prueba de forma rápida para tus entidades.
</p>

<h3>5.1. Crear fixtures</h3>

<pre><code class="language-bash">
composer require --dev doctrine/doctrine-fixtures-bundle
php bin/console make:fixtures HotelFixtures
composer require --dev fakerphp/faker
</code></pre>

<h3>5.2. Fixture con Faker</h3>

<pre><code class="language-php">
&lt;?php
namespace App\DataFixtures;

use App\Entity\Hotel;
use Doctrine\Bundle\FixturesBundle\Fixture;
use Doctrine\Persistence\ObjectManager;
use Faker\Factory;

class HotelFixtures extends Fixture
{
  public function load(ObjectManager $manager): void
  {
    $faker = Factory::create('es_ES');

    for ($i = 0; $i < 10; $i++) {
      $hotel = new Hotel();
      $hotel->setNombre($faker->company());
      $hotel->setDireccion($faker->address());

      $manager->persist($hotel);
    }

    $manager->flush();
  }
}
</code></pre>

<h3>5.3. Cargar fixtures</h3>

<pre><code class="language-bash">
php bin/console doctrine:fixtures:load
</code></pre>
</section>

<!-- SECCIÓN 6 -->
<section id="seed">
<h2>6. Repositorios y consultas</h2>

<p>
Aquí aprenderás a crear repositorios personalizados y consultas específicas.
</p>

<h3>6.1. Repositorio personalizado</h3>

<pre><code class="language-php">
// src/Repository/HotelRepository.php
namespace App\Repository;

use App\Entity\Hotel;
use Doctrine\Bundle\DoctrineBundle\Repository\ServiceEntityRepository;
use Doctrine\Persistence\ManagerRegistry;

class HotelRepository extends ServiceEntityRepository
{
  public function __construct(ManagerRegistry $registry)
  {
    parent::__construct($registry, Hotel::class);
  }

  public function buscarPorNombre(string $nombre): array
  {
    return $this->createQueryBuilder('h')
      ->where('h.nombre LIKE :nombre')
      ->setParameter('nombre', '%' . $nombre . '%')
      ->getQuery()
      ->getResult();
  }
}
</code></pre>

<h3>6.2. Uso del repositorio</h3>

<pre><code class="language-php">
$hoteles = $hotelRepository->buscarPorNombre('Hotel');
</code></pre>
</section>

<!-- DIAGRAMA -->
<section>
<h2>Diagrama conceptual</h2>

<p>
Este diagrama resume la relación entre entidades para visualizar la estructura de datos.
</p>

<div class="mermaid">
classDiagram
class Hotel {
    id
    nombre
    direccion
}
class Gerente {
    id
    nombre
    email
    hotel_id
}
class Habitacion {
    id
    numero
    tipo
    hotel_id
}
class Servicio {
    id
    nombre
    descripcion
}
class HotelServicio {
    hotel_id
    servicio_id
    precio_adicional
}
Hotel "1" --> "1" Gerente : tiene
Hotel "1" --> "*" Habitacion : tiene
Hotel "*" --> "*" Servicio : ofrece
HotelServicio --> Hotel
HotelServicio --> Servicio
</div>
</section>

<!-- RESUMEN -->
<section>
<div class="info-box">
<h3>Resumen rápido</h3>

<table border="1" style="width:100%; border-collapse:collapse;">
<tr><th>Elemento</th><th>Función</th></tr>
<tr><td>Entity</td><td>Representa una tabla</td></tr>
<tr><td>Doctrine</td><td>ORM de Symfony</td></tr>
<tr><td>Fixtures</td><td>Genera datos con Faker</td></tr>
<tr><td>Repository</td><td>Consultas personalizadas</td></tr>
<tr><td>CRUD</td><td>Operaciones con entidades</td></tr>
</table>
</div>
</section>

</main>

<footer>
<p>&copy; Stucom 2025-26. Todos los derechos reservados.</p>
</footer>
</body>
</html>
